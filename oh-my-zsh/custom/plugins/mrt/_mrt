#compdef mrt
#autoload

# mrt Autocomplete plugin for Oh-My-Zsh, based on homebrew completion
# Original author: Jason Paryani (https://github.com/jparyani)
# Shamelessly stolen from meteor autocompletion by Dimitri JORGE (https://github.com/jorge-d)

_mrt_all_packages() {
  if (( ! $+packages )); then
    echo -n " (caching package index...)"
  packages=(`curl https://atmosphere.meteor.com/ 2&>/dev/null | grep '_init_fast_render(' | python -c "import json, sys; f=sys.stdin.read(); a=f[f.find('_init_fast_render(')+18:-2]; print '\n'.join([row['name'] for row in json.loads(a)[u'collectionData']['packages'][0]])"`)
  fi
}
_mrt_installed_packages() {
  installed_packages=(`meteor list --using`)
}

local -a _1st_arguments
_1st_arguments=(
  'run:[Default] Run this project in local development mode'
  'create:Create a new project'
  'update:Upgrade this project to the latest version of Meteor'
  'add:Add a package to this project'
  'remove:Remove a package from this project'
  'list:List available packages'
  'help:Display Meteor help'
  'bundle:Pack this project up into a tarball'
  'mongo:Connect to the Mongo database for the specified site'
  'deploy:Deploy this project to Meteor'
  'logs:Show logs for specified site'
  'reset:Reset the project state. Erases the local database.'
  'test-packages:Test one or more packages'
)

local expl

if (( CURRENT == 2 )); then
  _describe -t commands "meteor subcommand" _1st_arguments
  return
fi

case "$words[2]" in
    help)
      _describe -t commands "meteor subcommand" _1st_arguments ;;
    remove)
      _mrt_installed_packages
      _wanted installed_packages expl 'installed packages' compadd -a installed_packages ;;
    add)
      _mrt_all_packages
      _wanted packages expl 'all packages' compadd -a packages ;;
esac